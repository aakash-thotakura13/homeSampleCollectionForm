<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Home Sample Collection Report</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px 10px;
        font-size: 14px;
      }
      h1,
      h2 {
        padding: 2px 4px;
        margin: 2px;
        text-align: center;
        color: #005d06;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        font-size: 14px;
      }
      th,
      td {
        padding: 6px 10px;
        border: 1px solid #ccc;
        text-align: left;
      }
      th {
        background-color: #f0f0f0;
        text-align: center;
      }
      .section {
        margin-top: 20px;
      }
      .highlight {
        background-color: #779c80;
      }
      .highlight > tr > th {
        text-align: left;
      }
      .highlight > tr > td {
        text-align: right;
      }
      .grade-high {
        color: #d9534f; /* Red */
        font-weight: bold;
      }
      .grade-medium {
        color: #f0ad4e; /* Orange */
        font-weight: bold;
      }
      .bmi-note {
        font-size: 12px;
        margin-top: 15px;
        color: #555;
      }
      .grade-normal {
        color: green;
        font-weight: bold;
      }
      .grade-warning {
        color: #f0ad4e; /* Yellow */
        font-weight: bold;
      }
      .grade-orange {
        color: orange;
        font-weight: bold;
      }
      .grade-danger {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="https://www.tricorderdiagnostics.com/siteimages/logo/tricorder_logo.svg" alt="Tricorder_Logo" width="150" />
      <address>Tricorder Diagnostics Pvt Ltd, Flat No: 201, Siri Sampada Arcade III, Behind Union Bank of India, Khajaguda, Hyderabad - 500032, Telangana</address>
    </div>

    <h1>Home Sample Collection Summary</h1>
    <p style="text-align: center; font-size: 12px; color: #777; padding: 1px; margin: 1px;">
      Generated on: 
      <%= generatedAt.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' }) %>, 
      <%= generatedAt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %>
    </p>

    <!-- GENERAL INFO -->
    <div class="section">
      <h2>General Information</h2>
      <table style="width: 100%;">
        <tr>
          <th>Full Name</th>
          <th>Age / Gender</th>
          <th>Mobile</th>
          <th>Email</th>
        </tr>
        <tr>
          <td><%= data.generalInfo?.fullName || "‚Äî" %></td>
          <td><%= data.generalInfo?.age || "‚Äî" %> / <%= data.generalInfo?.gender || "‚Äî" %></td>
          <td><%= data.generalInfo?.mobile || "‚Äî" %></td>
          <td><%= data.generalInfo?.email || "‚Äî" %></td>
        </tr>
        <tr>
          <!-- <th>Address</th> -->
          <!-- <th>Pincode</th> -->
          <th colspan="2">Google Pin</th>
          <th colspan="2">Booking ID</th>
        </tr>
        <tr>
          <!-- <td><%= data.generalInfo?.address || "‚Äî" %></td> -->
          <!-- <td><%= data.generalInfo?.pincode || "‚Äî" %></td> -->
          <td colspan="2"><%= data.generalInfo?.googleLocationPin || "‚Äî" %></td>
          <td colspan="2">BOOKING_ID</td>
        </tr>
      </table>
    </div>

    <!-- MEDICAL HISTORY -->
    <div class="section">
      <h2>Medical History</h2>
      <% 
        const weight = data.medicalHistory?.weight;
        const height = data.medicalHistory?.height;
        const waist = data.medicalHistory?.waist;
        const hip = data.medicalHistory?.hip;

        const bmi = (weight && height) ? (weight / Math.pow(height / 100, 2)).toFixed(2) : null;

        let bmiCategory = "";
        let bmiColorClass = "";

        if (bmi) {
          const bmiValue = parseFloat(bmi);
          if (bmiValue >= 18.5 && bmiValue <= 22.99) {
            bmiCategory = "Normal";
            bmiColorClass = "grade-normal";
          } else if (bmiValue >= 23 && bmiValue <= 24.9) {
            bmiCategory = "Grade I";
            bmiColorClass = "grade-warning";
          } else if (bmiValue >= 25 && bmiValue <= 27.5) {
            bmiCategory = "Grade II";
            bmiColorClass = "grade-warning";
          } else if (bmiValue >= 27.6 && bmiValue <= 32.4) {
            bmiCategory = "Grade III";
            bmiColorClass = "grade-orange";
          } else if (bmiValue >= 32.5) {
            bmiCategory = "Grade IV";
            bmiColorClass = "grade-danger";
          } else {
            bmiCategory = "Below Normal";
            bmiColorClass = "grade-warning";
          }
        }

        const waistHeightRatio = (waist && height)
          ? (height != 0 ? (waist / height).toFixed(2) : null)
          : null;

        let waistHeightCategory = "";
        if (waistHeightRatio) {
          waistHeightCategory = (parseFloat(waistHeightRatio) > 0.5) ? "Normal" : "Needs Attention";
        }
      %>

      <table style="width: 100%;">
        <tr>
          <th>Height (cm)</th>
          <th>Weight (kg)</th>
          <th>Waist (cm)</th>
          <th>BMI</th>
          <th>Waist-Height Ratio</th>
        </tr>
        <tr>
          <td><%= height || "‚Äî" %></td>
          <td><%= weight || "‚Äî" %></td>
          <td><%= waist || "‚Äî" %></td>

          <!-- BMI cell -->
          <td>
            <% if (bmi) { %> <%= bmi %> (<span class="<%= bmiColorClass %>"
              ><%= bmiCategory %></span
            >) <% } else { %> ‚Äî <% } %>
          </td>

          <!-- Waist-Height Ratio cell -->
          <td>
            <% if (waistHeightRatio) { %> <%= waistHeightRatio %> (<%=
            waistHeightCategory %>) <% } else { %> ‚Äî <% } %>
          </td>
        </tr>
      </table>

      <!-- BMI Grading Note -->
      <div class="bmi-note">
        <h3 style="margin: 0px; padding: 0px; text-align: center; border-bottom: 1px solid #ccc;">BMI Grading:</h3>
        <p style="display: flex; justify-content: space-around; flex-wrap: wrap; align-items: center;"><i>
          <span>Normal: 18.5-22.99 kg/m¬≤</span>
          <span>Grade I: 23-24.9 kg/m¬≤</span>
          <span>Grade II: 25-27.5 kg/m¬≤</span>
          <span>Grade III: 27.6-32.4 kg/m¬≤</span>
          <span>Grade IV: ‚â•32.5 kg/m¬≤</span>
        </i>
        </p>
      </div>
    </div>

    <!-- TEST & COLLECTION INFO -->
    <div class="section">
      <h2>Test & Collection Details</h2>
      <table style="width: 100%;">
        <tr>
          <th>Fasting Confirmation</th>
          <!-- <th>Fainting History</th> -->
          <th>Blood Thinners</th>
          <th>Allergies</th>
          <th>Request Type</th>
        </tr>
        <tr>
          <td><%= data.testNCollection?.fastingConfirmation || "‚Äî" %></td>
          <!-- <td><%= data.testAndCollectionInfo?.faintingHistory || "‚Äî" %></td> -->
          <td><%= data.testNCollection?.bloodThinners || "‚Äî" %></td>
          <td><%= data.testNCollection?.hasAllergies || "‚Äî" %></td>
          <td><%= data.testNCollection?.requestType || "‚Äî" %></td>
        </tr>
      </table>
    </div>

    <!-- SELECTED TESTS -->
    <div class="section">
      <h2>Selected Tests</h2>

      <% if (Array.isArray(data.testsInfo) && data.testsInfo.length > 0)
      { %>
      <table style="width: 100%;">

        <tr>
          <th>Test Name</th>
          <th>Price (‚Çπ)</th>
        </tr>

        <%
          let totalPrice = 0;
          data.testsInfo.forEach(test => { totalPrice += test.price;
        %>
        
        <tr style="font-size: 12px;">
          <td style="border: none; border-right: 1px solid #ccc; border-left: 1px solid #ccc; text-align: left;"><%= test.testName %></td>
          <td style="border: none; border-right: 1px solid #ccc; border-left: 1px solid #ccc; text-align: right;">‚Çπ<%= test.price %></td>
        </tr>
        <% }) %>

        <tr class="highlight">
          <th style="text-align: left;" >Total Price</th>
          <td style="text-align: right;">‚Çπ<%= totalPrice %></td>
        </tr>

        <% if (totalPrice > 1000) { let discount = Math.round(totalPrice * 0.2);
        let discountedPrice = totalPrice - discount; %>

        <tr class="highlight">
          <th style="text-align: left;" >Discount (20%)</th>
          <td style="text-align: right;">-‚Çπ<%= discount %></td>
        </tr>
        
        <tr class="highlight">
          <th style="text-align: left;" >Final Price after Discount</th>
          <td style="text-align: right;">‚Çπ<%= discountedPrice %></td>
        </tr>
        <% } %>

      </table>

      <% } else { %>
      <p>No tests selected.</p>
      <% } %>
    
    </div>

    <div class="section">
      <h2>Instructions</h2>
      <ul>
        <li>Please bring this receipt with you at the time of collection.</li>
        <li>Ensure you are fasting for 8-12 hours before the test.</li>
        <li>Drink plenty of water to stay hydrated.</li>
        <li>If you have any allergies or medical conditions, please inform the technician.</li>
        <li>For any queries, contact us at <strong>+91 12345 67890</strong>.</li>
      </ul>
    </div>

    <h4>For any queries, contact us at <strong>+91 99 66 66 87 97</strong>.</h4>

    <footer style="text-align: center; font-size: 12px; color: #888; margin-top: 50px; border-top: 1px solid #ccc; padding-top: 10px;">
      <p>Thank you for choosing <strong>Tricorder Home Collection Services</strong> üôè</p>
      <p>Stay Healthy. Stay Happy.</p>
    </footer>
  </body>
</html>
